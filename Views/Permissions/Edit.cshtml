@model CmsTools.Models.TablePermissionEditViewModel

@{
    ViewData["Title"] = "Sửa quyền - " + Model.RoleName;
}

<h2 class="mt-3 mb-3">Sửa quyền cho role: @Model.RoleName</h2>

@if (TempData["PermMessage"] is string msg && !string.IsNullOrWhiteSpace(msg))
{
    <div class="alert alert-info">@msg</div>
}

@if (Model.CopyRoles != null && Model.CopyRoles.Count > 0)
{
    <form asp-controller="Permissions"
          asp-action="CopyFrom"
          method="post"
          class="row g-2 mb-3">
        @Html.AntiForgeryToken()
        <input type="hidden" name="roleId" value="@Model.RoleId" />

        <div class="col-auto">
            <label class="form-label small mb-0">Copy quyền từ role khác:</label>
        </div>
        <div class="col-auto">
            <select name="fromRoleId" class="form-select form-select-sm">
                <option value="">-- Chọn role nguồn --</option>
                @foreach (var r in Model.CopyRoles)
                {
                    var selected = Model.CopyFromRoleId.HasValue && Model.CopyFromRoleId.Value == r.Id;

                    <option value="@r.Id" selected="@(selected ? "selected" : null)">
                        @r.Name
                    </option>
                }
            </select>

        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-sm btn-outline-secondary">
                Copy
            </button>
        </div>
        <div class="col-12">
            <small class="text-muted">
                Copy chỉ <strong>nạp vào form</strong>, bạn vẫn cần bấm <strong>Lưu quyền</strong> để ghi xuống DB.
            </small>
        </div>
    </form>
}

<form asp-controller="Permissions" asp-action="Edit" method="post">
    @Html.AntiForgeryToken()

    <input type="hidden" asp-for="RoleId" />

    <div class="mb-2 text-muted">
        <small>
            Tick vào Xem / Tạo / Sửa / Xóa cho từng bảng.
            Nếu không chọn flag nào và không nhập row_filter thì role coi như không có rule riêng cho bảng đó.
        </small>
    </div>

    <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th style="width:60px;">#</th>
                    <th>Connection</th>
                    <th>Bảng</th>
                    <th style="width:80px;">Xem</th>
                    <th style="width:80px;">Tạo</th>
                    <th style="width:80px;">Sửa</th>
                    <th style="width:80px;">Xóa</th>
                    <th>Row filter (WHERE ...)</th>
                </tr>
            </thead>
            <tbody>
                @for (int i = 0; i < Model.Items.Count; i++)
                {
                    var item = Model.Items[i];
                    <tr>
                        <td>@(i + 1)</td>

                        <td>@item.ConnectionName</td>

                        <td>
                            <strong>@item.DisplayName</strong><br />
                            <small class="text-muted">@item.TableName</small>

                            @* Hidden để bind TableId *@
                            <input type="hidden" asp-for="Items[@i].TableId" />
                            <input type="hidden" asp-for="Items[@i].TableName" />
                            <input type="hidden" asp-for="Items[@i].DisplayName" />
                            <input type="hidden" asp-for="Items[@i].ConnectionName" />
                        </td>

                        <td class="text-center">
                            <input class="form-check-input" type="checkbox"
                                   asp-for="Items[@i].CanView" />
                        </td>
                        <td class="text-center">
                            <input class="form-check-input" type="checkbox"
                                   asp-for="Items[@i].CanCreate" />
                        </td>
                        <td class="text-center">
                            <input class="form-check-input" type="checkbox"
                                   asp-for="Items[@i].CanUpdate" />
                        </td>
                        <td class="text-center">
                            <input class="form-check-input" type="checkbox"
                                   asp-for="Items[@i].CanDelete" />
                        </td>
                        <td>
                            <input class="form-control form-control-sm"
                                   asp-for="Items[@i].RowFilter"
                                   placeholder="vd: status <> 0" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <button type="submit" class="btn btn-primary mt-2">Lưu quyền</button>
    <a asp-controller="Permissions" asp-action="Index"
       class="btn btn-secondary mt-2 ms-2">
        Quay lại
    </a>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}

@model CmsTools.Models.TablePermissionEditViewModel

@{
    ViewData["Title"] = "Sửa quyền - " + Model.RoleName;
}

<h2 class="mt-3 mb-3">Sửa quyền cho role: @Model.RoleName</h2>

@if (TempData["PermMessage"] is string msg && !string.IsNullOrWhiteSpace(msg))
{
    <div class="alert alert-info">@msg</div>
}

@if (Model.CopyRoles != null && Model.CopyRoles.Count > 0)
{
    <form asp-controller="Permissions"
          asp-action="CopyFrom"
          method="post"
          class="row g-2 mb-3">
        @Html.AntiForgeryToken()
        <input type="hidden" name="roleId" value="@Model.RoleId" />

        <div class="col-auto">
            <label class="form-label small mb-0">Copy quyền từ role khác:</label>
        </div>
        <div class="col-auto">
            <select name="fromRoleId" class="form-select form-select-sm">
                <option value="">-- Chọn role nguồn --</option>
                @foreach (var r in Model.CopyRoles)
                {
                    var selected = Model.CopyFromRoleId.HasValue && Model.CopyFromRoleId.Value == r.Id;
                    <option value="@r.Id" selected="@(selected ? "selected" : null)">
                        @r.Name
                    </option>
                }
            </select>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-sm btn-outline-secondary">
                Copy
            </button>
        </div>
        <div class="col-12">
            <small class="text-muted">
                Copy chỉ <strong>nạp vào form</strong>, bạn vẫn cần bấm <strong>Lưu quyền</strong> để ghi xuống DB.
            </small>
        </div>
    </form>
}

<form asp-controller="Permissions" asp-action="Edit" method="post">
    @Html.AntiForgeryToken()

    <input type="hidden" asp-for="RoleId" />

    <div class="mb-2 text-muted">
        <small>
            Tick vào Xem / Tạo / Sửa / Xóa và các quyền trạng thái (Publish/Schedule/Archive).
            Nếu không chọn flag nào và không nhập row_filter thì role coi như không có rule riêng cho bảng đó.
        </small>
    </div>

    <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th style="width:60px;">#</th>
                    <th>Connection</th>
                    <th>Bảng</th>

                    <th class="text-center" style="width:86px;">
                        Xem<br />
                        <input type="checkbox" class="form-check-input js-col-all" data-col="view" title="Chọn/Bỏ tất cả Xem" />
                    </th>
                    <th class="text-center" style="width:86px;">
                        Tạo<br />
                        <input type="checkbox" class="form-check-input js-col-all" data-col="create" title="Chọn/Bỏ tất cả Tạo" />
                    </th>
                    <th class="text-center" style="width:86px;">
                        Sửa<br />
                        <input type="checkbox" class="form-check-input js-col-all" data-col="update" title="Chọn/Bỏ tất cả Sửa" />
                    </th>
                    <th class="text-center" style="width:86px;">
                        Xóa<br />
                        <input type="checkbox" class="form-check-input js-col-all" data-col="delete" title="Chọn/Bỏ tất cả Xóa" />
                    </th>

                    <th class="text-center" style="width:110px;">
                        Publish<br />
                        <input type="checkbox" class="form-check-input js-col-all" data-col="publish" title="Chọn/Bỏ tất cả Publish" />
                    </th>
                    <th class="text-center" style="width:110px;">
                        Schedule<br />
                        <input type="checkbox" class="form-check-input js-col-all" data-col="schedule" title="Chọn/Bỏ tất cả Schedule" />
                    </th>
                    <th class="text-center" style="width:110px;">
                        Archive<br />
                        <input type="checkbox" class="form-check-input js-col-all" data-col="archive" title="Chọn/Bỏ tất cả Archive" />
                    </th>

                    <th>Row filter (WHERE ...)</th>
                </tr>
            </thead>

            <tbody>
                @for (int i = 0; i < Model.Items.Count; i++)
                {
                    var item = Model.Items[i];
                    <tr>
                        <td>@(i + 1)</td>

                        <td>@item.ConnectionName</td>

                        <td>
                            <strong>@item.DisplayName</strong><br />
                            <small class="text-muted">@item.TableName</small>

                            @* Hidden để bind TableId *@
                            <input type="hidden" asp-for="Items[@i].TableId" />
                            <input type="hidden" asp-for="Items[@i].TableName" />
                            <input type="hidden" asp-for="Items[@i].DisplayName" />
                            <input type="hidden" asp-for="Items[@i].ConnectionName" />
                        </td>

                        <td class="text-center">
                            <input class="form-check-input js-col-view" type="checkbox" asp-for="Items[@i].CanView" />
                        </td>
                        <td class="text-center">
                            <input class="form-check-input js-col-create" type="checkbox" asp-for="Items[@i].CanCreate" />
                        </td>
                        <td class="text-center">
                            <input class="form-check-input js-col-update" type="checkbox" asp-for="Items[@i].CanUpdate" />
                        </td>
                        <td class="text-center">
                            <input class="form-check-input js-col-delete" type="checkbox" asp-for="Items[@i].CanDelete" />
                        </td>

                        <td class="text-center">
                            <input class="form-check-input js-col-publish" type="checkbox" asp-for="Items[@i].CanPublish" />
                        </td>
                        <td class="text-center">
                            <input class="form-check-input js-col-schedule" type="checkbox" asp-for="Items[@i].CanSchedule" />
                        </td>
                        <td class="text-center">
                            <input class="form-check-input js-col-archive" type="checkbox" asp-for="Items[@i].CanArchive" />
                        </td>

                        <td>
                            <input class="form-control form-control-sm"
                                   asp-for="Items[@i].RowFilter"
                                   placeholder="vd: status <> 0" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <button type="submit" class="btn btn-primary mt-2">Lưu quyền</button>
    <a asp-controller="Permissions" asp-action="Index" class="btn btn-secondary mt-2 ms-2">
        Quay lại
    </a>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {
            function setAll(selector, checked) {
                document.querySelectorAll(selector).forEach(function (el) {
                    if (!el.disabled) el.checked = checked;
                });
            }

            document.querySelectorAll(".js-col-all").forEach(function (hdr) {
                hdr.addEventListener("change", function () {
                    var col = hdr.getAttribute("data-col");
                    if (!col) return;

                    var map = {
                        view: ".js-col-view",
                        create: ".js-col-create",
                        update: ".js-col-update",
                        delete: ".js-col-delete",
                        publish: ".js-col-publish",
                        schedule: ".js-col-schedule",
                        archive: ".js-col-archive"
                    };

                    var sel = map[col];
                    if (!sel) return;

                    setAll(sel, hdr.checked);
                });
            });
        })();
    </script>
}

@model List<CmsTools.Models.CmsArticleListItemVm>

@{
    ViewData["Title"] = "Bài viết";

    int page = (int)(ViewBag.Page ?? 1);
    int pageSize = (int)(ViewBag.PageSize ?? 20);
    int total = (int)(ViewBag.Total ?? 0);
    int totalPages = (int)Math.Ceiling(total / (double)pageSize);

    string q = (string)(ViewBag.Q ?? "");
    byte? status = ViewBag.Status as byte?;
    string categorySlug = (string)(ViewBag.CategorySlug ?? "");
    string tagSlug = (string)(ViewBag.TagSlug ?? "");
}

<style>
    /* ===== Articles List Responsive ===== */
    .articles-table {
        table-layout: fixed;
        width: 100%;
    }

        /* chống “dính chữ” header + cell khi cột bị bóp */
        .articles-table th, .articles-table td {
            overflow: hidden;
            vertical-align: middle;
        }

        .articles-table thead th {
            white-space: nowrap;
            text-overflow: ellipsis;
        }

    /* Title: tối đa 2 dòng */
    .title-clamp {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        word-break: break-word;
        overflow-wrap: anywhere;
    }

    /* Truncate 1 dòng */
    .text-truncate-1 {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
        max-width: 100%;
    }

    code.slug-code {
        font-size: .9rem;
        padding: .15rem .35rem;
    }

    /* ✅ Hiển thị ĐUÔI slug (giữ phần cuối khác nhau) */
    .slug-tail {
        direction: rtl;
        text-align: left; /* giữ cảm giác “căn trái” */
        unicode-bidi: plaintext; /* tránh đảo ký tự lạ */
    }

    /* Link trong bảng nhìn gọn */
    .row-link {
        color: inherit;
        text-decoration: none;
    }

        .row-link:hover {
            text-decoration: underline;
        }

    @@media (max-width: 576px) {
        .articles-toolbar .btn {
            width: 100%;
        }

        .articles-toolbar h3 {
            font-size: 1.15rem;
        }
    }
</style>

<div class="d-flex align-items-center justify-content-between mb-3 articles-toolbar">
    <h3 class="mb-0">Quản lý bài viết</h3>
    <a class="btn btn-primary" href="/Articles/Edit">+ Tạo bài viết</a>
</div>

<form method="get" class="row g-2 mb-3">
    <div class="col-md-4">
        <input class="form-control" name="q" value="@q" placeholder="Tìm theo tiêu đề / slug / nội dung..." />
    </div>

    <div class="col-md-2">
        <select class="form-select" name="status">
            <option value="">-- Trạng thái --</option>
            <option value="0" selected="@(status == 0)">Nháp</option>
            <option value="1" selected="@(status == 1)">Đã đăng</option>
            <option value="2" selected="@(status == 2)">Hẹn giờ</option>
            <option value="3" selected="@(status == 3)">Lưu trữ</option>
        </select>
    </div>

    <div class="col-md-2">
        <input class="form-control" name="categorySlug" value="@categorySlug" placeholder="Slug danh mục" />
    </div>

    <div class="col-md-2">
        <input class="form-control" name="tagSlug" value="@tagSlug" placeholder="Slug thẻ" />
    </div>

    <div class="col-md-2 d-grid">
        <button class="btn btn-outline-secondary" type="submit">Lọc</button>
    </div>
</form>

<div class="table-responsive">
    <table class="table table-hover align-middle articles-table">
        <thead>
            <tr>
                <th style="width:64px">ID</th>
                <th>Tiêu đề</th>

                <!-- Slug: chỉ hiện từ xl trở lên -->
                <th class="d-none d-xl-table-cell" style="width:220px">Slug</th>

                <th style="width:110px">Trạng thái</th>
                <th style="width:160px">Hẹn đăng (VN)</th>

                <!-- Ẩn Trang chủ trên < lg -->
                <th class="d-none d-lg-table-cell" style="width:110px">Trang chủ</th>

                <th style="width:160px">Cập nhật (VN)</th>
                <th style="width:100px"></th>
            </tr>
        </thead>

        <tbody>
            @if (Model == null || Model.Count == 0)
            {
                <tr><td colspan="8" class="text-muted">Chưa có bài viết.</td></tr>
            }
            else
            {
                foreach (var a in Model)
                {
                    string statusText = a.Status switch
                    {
                        1 => "Đã đăng",
                        2 => "Hẹn giờ",
                        3 => "Lưu trữ",
                        _ => "Nháp"
                    };

                    var editUrl = $"/Articles/Edit/{a.Id}";

                    <tr>
                        <td>@a.Id</td>

                        <!-- ✅ Title clickable + slug tail dưới title khi < xl -->
                        <td>
                            <a class="fw-semibold title-clamp row-link" href="@editUrl" title="@a.Title">
                                @a.Title
                            </a>

                            <div class="d-xl-none small text-muted text-truncate-1 mt-1">
                                <a class="row-link" href="@editUrl" title="@a.Slug">
                                    <code class="slug-code slug-tail">@a.Slug</code>
                                </a>
                            </div>
                        </td>

                        <!-- ✅ Slug tail ở cột riêng (xl+) -->
                        <td class="d-none d-xl-table-cell">
                            <a class="row-link" href="@editUrl" title="@a.Slug">
                                <code class="slug-code text-truncate-1 slug-tail">@a.Slug</code>
                            </a>
                        </td>

                        <td>@statusText</td>

                        <td>
                            @if (a.Status == 2 && a.Scheduled_At_Utc != null)
                            {
                                @a.Scheduled_At_Utc.Value.AddHours(7).ToString("dd/MM/yyyy HH:mm")
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>

                        <td class="d-none d-lg-table-cell">
                            @(a.Is_Featured ? $"Có (#{a.Featured_Order?.ToString() ?? "-"})" : "Không")
                        </td>

                        <td>@a.Updated_At_Utc.AddHours(7).ToString("dd/MM/yyyy HH:mm")</td>

                        <td class="text-end">
                            <!-- ✅ dễ phân biệt hơn -->
                            <a class="btn btn-sm btn-outline-primary" href="@editUrl">Sửa #@a.Id</a>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

@if (totalPages > 1)
{
    <nav>
        <ul class="pagination">
            @for (int i = 1; i <= totalPages; i++)
            {
                var active = (i == page) ? "active" : "";
                var url = $"/Articles?q={Uri.EscapeDataString(q ?? "")}&status={status}&categorySlug={Uri.EscapeDataString(categorySlug ?? "")}&tagSlug={Uri.EscapeDataString(tagSlug ?? "")}&page={i}&pageSize={pageSize}";
                <li class="page-item @active">
                    <a class="page-link" href="@url">@i</a>
                </li>
            }
        </ul>
    </nav>
}

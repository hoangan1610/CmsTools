@model CmsTools.Models.AdminReviewViewModel

@{
    // Base URL của API để ráp link ảnh nếu DB lưu path tương đối
    var fileBaseUrl = "https://api.hafood.id.vn";
}

<div class="modal-header">
    <h5 class="modal-title">
        Đánh giá #@Model.Id – @Model.Product_Name
    </h5>

    <a href="@($"/Product/Product.aspx?id={Model.Product_Id}")"
       target="_blank"
       class="btn btn-sm btn-outline-primary me-2">
        Xem trên HAFood
    </a>

    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
</div>

<div class="modal-body">
    <div class="mb-2 small text-muted">
        Khách: <strong>@Model.User_Name</strong><br />
        Đánh giá lúc: @Model.Created_At.ToString("dd/MM/yyyy HH:mm")
    </div>

    <div class="mb-2">
        <strong>Điểm:</strong>
        @for (var i = 1; i <= 5; i++)
        {
            if (i <= Model.Rating)
            {
                @:<i class="bi bi-star-fill text-warning"></i>
            }
            else
            {
                @:<i class="bi bi-star text-secondary"></i>
            }
        }
    </div>

    <div class="mb-2">
        <strong>Tiêu đề:</strong> @Model.Title
    </div>

    <div class="mb-3">
        <strong>Nội dung:</strong>
        <div class="border rounded p-2" style="white-space:pre-wrap;font-size:.9rem;">
            @Model.Content
        </div>
    </div>

    @* ==== HÌNH ẢNH ĐÍNH KÈM (NẾU CÓ) ==== *@
    @if (Model.Images != null && Model.Images.Count > 0)
    {
        <div class="mb-3">
            <strong>Hình ảnh đính kèm:</strong>
            <div class="d-flex flex-wrap gap-2 mt-1">
                @foreach (var img in Model.Images)
                {
                    var src = img.Image_Url ?? "";

                    if (!string.IsNullOrWhiteSpace(src)
                    && !src.StartsWith("http", StringComparison.OrdinalIgnoreCase))
                    {
                        src = fileBaseUrl.TrimEnd('/') + "/" + src.TrimStart('/');
                    }

                    <a href="@src"
                       target="_blank"
                       rel="noopener noreferrer"
                       class="me-2 mb-2">
                        <img src="@src"
                             class="img-thumbnail"
                             style="max-width:120px; max-height:120px; object-fit:cover;" />
                    </a>
                }
            </div>
        </div>
    }

    <div class="mb-2">
        <span class="badge @(Model.Is_Verified_Purchase ? "bg-success" : "bg-secondary")">
            @(Model.Is_Verified_Purchase ? "Đã mua hàng" : "Chưa xác minh mua hàng")
        </span>
        @if (Model.Has_Image)
        {
            <span class="badge bg-info ms-1">Có hình ảnh</span>
        }
    </div>

    <div class="mb-3">
        <strong>Trạng thái hiện tại:</strong>
        @{
            string statusText = "Chờ duyệt";
            string statusClass = "badge bg-warning text-dark";
            if (Model.Status == 1) { statusText = "Đã duyệt"; statusClass = "badge bg-success"; }
            else if (Model.Status == 2) { statusText = "Đã từ chối"; statusClass = "badge bg-danger"; }
        }
        <span class="@statusClass">@statusText</span>

        @* Badge ẩn/hiện trên web *@
        @if (Model.Is_Hidden)
        {
            <span class="badge bg-dark ms-1">Đã ẩn khỏi web</span>
        }
        else
        {
            <span class="badge bg-primary ms-1">Đang hiển thị</span>
        }
    </div>

    @* ==== FORM CẬP NHẬT TRẠNG THÁI – chỉ cho phép khi đang CHỜ DUYỆT ==== *@
    @if (Model.Status == 0)
    {
        @using (Html.BeginForm("SetStatus", "AdminReviews", FormMethod.Post,
            new { id = "frmReviewStatus", data_cms_ajax = "true" }))
        {
            @Html.AntiForgeryToken()
            @Html.Hidden("id", Model.Id)

            <div class="mb-2">
                <label class="form-label">
                    Lý do từ chối
                    <span class="text-danger">(bắt buộc khi chọn &quot;Từ chối&quot;)</span>
                </label>
                <textarea name="rejectedReason"
                  class="form-control form-control-sm"
                  rows="2"
                  placeholder="Ví dụ: Nội dung không phù hợp, sai sự thật..."></textarea>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="small text-muted">
                    Thao tác trạng thái đánh giá
                </div>
                <div class="text-end">
                    <!-- 2 = rejected -->
                    <button type="submit"
                            class="btn btn-danger btn-sm"
                            name="newStatus" value="2">
                        Từ chối
                    </button>

                    <!-- 1 = approved -->
                    <button type="submit"
                            class="btn btn-success btn-sm ms-1"
                            name="newStatus" value="1">
                        Duyệt
                    </button>
                </div>
            </div>
        }
    }
    else
    {
        <div class="alert alert-info py-2">
            Trạng thái đánh giá đã được xử lý.
            Anh vẫn có thể <strong>trả lời/điều chỉnh phản hồi</strong> ở bên dưới.
            Nếu thật sự cần thay đổi trạng thái, anh có thể thao tác ở trang quản trị nâng cao
            hoặc chỉnh trực tiếp trong DB.
        </div>
    }

    @* ==== FORM ẨN / HIỆN REVIEW (is_hidden) – luôn cho phép thao tác riêng với status ==== *@
    @using (Html.BeginForm("SetHidden", "AdminReviews", FormMethod.Post,
        new { id = "frmReviewHidden", data_cms_ajax = "true", @class = "mt-3" }))
    {
        @Html.AntiForgeryToken()
        @Html.Hidden("id", Model.Id)
        @Html.Hidden("isHidden", !Model.Is_Hidden)  @* gửi giá trị sẽ đổi sang *@

        <div class="d-flex justify-content-between align-items-center">
            <div class="small text-muted">
                Ẩn/hiện đánh giá này trên web HAFood
            </div>
            <div class="text-end">
                @if (Model.Is_Hidden)
                {
                    <button type="submit" class="btn btn-outline-success btn-sm">
                        Hiện lại đánh giá
                    </button>
                }
                else
                {
                    <button type="submit" class="btn btn-outline-dark btn-sm">
                        Ẩn khỏi web
                    </button>
                }
            </div>
        </div>
    }

    <hr class="my-3" />

    @* ==== PHẦN PHẢN HỒI CỦA SHOP ==== *@
    <h6 class="mb-2">Phản hồi của shop</h6>

    @if (!string.IsNullOrWhiteSpace(Model.Reply_Content))
    {
        <div class="mb-2 small text-muted">
            Đã trả lời
            @if (!string.IsNullOrWhiteSpace(Model.Reply_Admin_Name))
            {
                @: bởi <strong>@Model.Reply_Admin_Name</strong>
            }
            @if (Model.Reply_Created_At.HasValue)
            {
                @: lúc @Model.Reply_Created_At.Value.ToString("dd/MM/yyyy HH:mm")
            }
        </div>
        <div class="border rounded p-2 bg-light mb-3" style="white-space:pre-wrap;font-size:.9rem;">
            @Model.Reply_Content
        </div>
    }
    else
    {
        <div class="mb-2 small text-muted text-danger">
            Chưa có phản hồi cho đánh giá này.
        </div>
    }

    @using (Html.BeginForm("SaveReply", "AdminReviews", FormMethod.Post,
        new { id = "frmReviewReply", data_cms_ajax = "true" }))
    {
        @Html.AntiForgeryToken()
        @Html.Hidden("id", Model.Id)

        <div class="mb-2">
            <label class="form-label">Nội dung phản hồi gửi cho khách</label>
            <textarea name="content"
                  class="form-control form-control-sm"
                  rows="3"
                  placeholder="Ví dụ: Cảm ơn bạn đã đánh giá, shop xin ghi nhận góp ý...">@Model.Reply_Content</textarea>
            <div class="form-text">
                Khi lưu, phản hồi sẽ hiển thị dưới đánh giá và gửi thông báo in-app cho khách.
            </div>
        </div>

        <div class="d-flex justify-content-end mt-2">
            <button type="submit" class="btn btn-outline-primary btn-sm">
                Lưu phản hồi &amp; gửi thông báo
            </button>
        </div>
    }

    <div class="mt-3 text-end">
        <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">
            Đóng
        </button>
    </div>
</div>

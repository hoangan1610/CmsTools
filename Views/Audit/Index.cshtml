@model CmsTools.Models.CmsAuditLogListViewModel

@{
    ViewData["Title"] = "Audit log";
}

<h2 class="mt-3 mb-3">Audit log</h2>

<form method="get" class="row g-2 mb-3">
    <div class="col-6 col-md-2">
        <label class="form-label small">Operation</label>
        <input name="op"
               class="form-control form-control-sm"
               value="@(Model.Operation ?? "")"
               placeholder="CREATE / UPDATE / SET_STATUS" />
    </div>
    <div class="col-6 col-md-3">
        <label class="form-label small">Table</label>
        <input name="table"
               class="form-control form-control-sm"
               value="@(Model.TableFilter ?? "")"
               placeholder="tbl_product, tbl_orders..." />
    </div>
    <div class="col-6 col-md-2">
        <label class="form-label small">From (UTC)</label>
        <input name="from"
               class="form-control form-control-sm"
               value="@(Model.From ?? "")"
               placeholder="2025-01-01" />
    </div>
    <div class="col-6 col-md-2">
        <label class="form-label small">To (UTC)</label>
        <input name="to"
               class="form-control form-control-sm"
               value="@(Model.To ?? "")"
               placeholder="2025-12-31" />
    </div>
    <div class="col-12 col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-primary btn-sm me-2">Lọc</button>
        <a href="@Url.Action("Index", "Audit")"
           class="btn btn-outline-secondary btn-sm">Xoá lọc</a>
    </div>
</form>

@if (Model.Items == null || Model.Items.Count == 0)
{
    <p class="text-muted">Chưa có bản ghi log nào.</p>
}
else
{
    <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th style="width:70px;">ID</th>
                    <th style="width:150px;">Thời gian (UTC)</th>
                    <th>User</th>
                    <th style="width:110px;">Operation</th>
                    <th>Bảng</th>
                    <th>PK</th>
                    <th style="width:120px;">IP</th>
                    <th style="width:80px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Items)
                {
                    <tr>
                        <td>@item.Id</td>
                        <td>@item.CreatedAtUtc.ToString("yyyy-MM-dd HH:mm")</td>
                        <td>@(item.Username ?? (item.UserId.HasValue ? ("#" + item.UserId.Value) : "(null)"))</td>
                        <td>
                            <span class="badge bg-secondary">@item.Operation</span>
                        </td>
                        <td>@item.TableFullName</td>
                        <td>
                            @if (!string.IsNullOrEmpty(item.PrimaryKeyColumn))
                            {
                                <code>@item.PrimaryKeyColumn=@item.PrimaryKeyValue</code>
                            }
                        </td>
                        <td>@item.IpAddress</td>
                        <td>
                            <a class="btn btn-sm btn-outline-primary"
                               href="@Url.Action("Details", "Audit", new { id = item.Id })">
                                Xem
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (Model.Total > Model.PageSize)
    {
        var totalPages = (int)Math.Ceiling(Model.Total / (double)Model.PageSize);

        <nav class="mt-2">
            <ul class="pagination pagination-sm">
                @for (int i = 1; i <= totalPages; i++)
                {
                    var active = i == Model.Page;
                    <li class="page-item @(active ? "active" : "")">
                        <a class="page-link"
                           href="@Url.Action("Index", "Audit", new {
                               op = Model.Operation,
                               table = Model.TableFilter,
                               from = Model.From,
                               to = Model.To,
                               page = i,
                               pageSize = Model.PageSize
                           })">
                            @i
                        </a>
                    </li>
                }
            </ul>
        </nav>
    }
}

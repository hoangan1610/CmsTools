@model CmsTools.Models.ProductVariantEditViewModel

@{
    ViewData["Title"] = "Thêm biến thể - " + Model.ProductName;

    // ✅ Không cho người dùng đụng JSON
    // Nhưng vẫn gửi JSON hợp lệ để khỏi lỗi CHECK(ISJSON)
    var metaToPost = string.IsNullOrWhiteSpace(Model.MetaData) ? "{}" : Model.MetaData;
}

<h2 class="mt-3 mb-3">Thêm biến thể</h2>
<p class="text-muted">Sản phẩm: <strong>@Model.ProductName</strong> (Mã: @Model.ProductId)</p>

<form asp-action="CreateVariant" asp-controller="Products" method="post" novalidate>
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="ProductId" />
    <input type="hidden" name="MetaData" value="@metaToPost" />

    <div class="mb-3">
        <label asp-for="Name" class="form-label">Tên biến thể</label>
        <input asp-for="Name" class="form-control" placeholder="Ví dụ: 200g, 500g, Vị cay..." />
        <small class="text-muted">Tên hiển thị cho khách hàng.</small>
    </div>

    <div class="mb-3">
        <label asp-for="Sku" class="form-label">Mã SKU</label>
        <input asp-for="Sku" class="form-control" placeholder="Ví dụ: KIDO-GA-CHANH-200" />
        <span asp-validation-for="Sku" class="text-danger"></span>
        <small class="text-muted">Mã quản lý kho/đơn hàng. Nên để duy nhất.</small>
    </div>

    @{
        var openId = "open_Image";
        var imgId = "preview_Image";
        var fileId = "file_Image";
        var statusId = "upstatus_Image";
        var clearId = "clear_Image";
        var helpId = "help_Image";
    }

    <div class="mb-3">
        <label asp-for="Image" class="form-label">Ảnh biến thể</label>

        <div class="input-group">
            <input id="field_Image"
                   name="Image"
                   class="form-control"
                   type="text"
                   value="@(Model.Image ?? "")"
                   placeholder="Dán URL ảnh hoặc chọn file để upload..."
                   data-preview-img="@imgId"
                   data-open-link="@openId"
                   data-clear-btn="@clearId"
                   aria-describedby="@helpId" />

            <a class="btn btn-outline-secondary disabled"
               id="@openId"
               href="javascript:void(0)"
               target="_blank"
               rel="noopener">Mở</a>

            <button class="btn btn-outline-danger" type="button" id="@clearId" title="Xoá giá trị">Xoá</button>
        </div>

        <div class="mt-2 d-flex flex-wrap gap-2 align-items-center">
            <input id="@fileId"
                   type="file"
                   class="form-control form-control-sm cms-img-file"
                   accept="image/*"
                   data-target-input="field_Image"
                   data-status-id="@statusId" />
            <span id="@statusId" class="small text-muted"></span>
        </div>

        <div class="mt-2">
            <img id="@imgId" class="cms-img-preview" alt="Xem trước" />
        </div>

        <small id="@helpId" class="text-muted">
            Có thể dán URL hoặc chọn file để upload (dùng HAFood API).
        </small>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <label asp-for="Weight" class="form-label">Khối lượng</label>
            <input asp-for="Weight" class="form-control" placeholder="Ví dụ: 200 (gram)" />
        </div>
        <div class="col-md-6 mb-3">
            <label asp-for="Stock" class="form-label">Tồn kho</label>
            <input asp-for="Stock" class="form-control" placeholder="Ví dụ: 50" />
        </div>
    </div>

    <div class="row">
        <div class="col-md-3 mb-3">
            <label asp-for="CostPrice" class="form-label">Giá nhập</label>
            <input asp-for="CostPrice" class="form-control" placeholder="Ví dụ: 35000" />
        </div>
        <div class="col-md-3 mb-3">
            <label asp-for="FinishedCost" class="form-label">Giá vốn hoàn thiện</label>
            <input asp-for="FinishedCost" class="form-control" placeholder="Ví dụ: 38000" />
        </div>
        <div class="col-md-3 mb-3">
            <label asp-for="WholesalePrice" class="form-label">Giá sỉ</label>
            <input asp-for="WholesalePrice" class="form-control" placeholder="Ví dụ: 45000" />
        </div>
        <div class="col-md-3 mb-3">
            <label asp-for="RetailPrice" class="form-label">Giá bán lẻ</label>
            <input asp-for="RetailPrice" class="form-control" placeholder="Ví dụ: 59000" />
        </div>
    </div>

    <div class="mb-3">
        <label asp-for="Status" class="form-label">Trạng thái</label>
        <select asp-for="Status" class="form-select">
            <option value="1">Đang bán (Hiển thị)</option>
            <option value="0">Tạm ẩn</option>
        </select>
    </div>

    <button type="submit" class="btn btn-primary">Lưu biến thể</button>
    <a class="btn btn-secondary"
       asp-controller="Products"
       asp-action="Detail"
       asp-route-id="@Model.ProductId">
        Quay lại
    </a>
</form>

<style>
    .cms-img-preview {
        max-height: 180px;
        display: none;
        max-width: 100%;
        object-fit: contain;
        border-radius: .75rem;
        border: 1px solid rgba(0,0,0,.08);
        background: #fafafa;
    }
</style>

@model CmsTools.Models.DataListViewModel
@using System.Globalization

@functions {
    bool IsImageColumn(CmsTools.Models.CmsColumnMeta col)
    {
        var name = (col.ColumnName ?? string.Empty).ToLowerInvariant();
        var fmt = (col.Format ?? string.Empty).ToLowerInvariant();

        // Ưu tiên: nếu format khai báo rõ là ảnh
        if (fmt == "img" || fmt == "image" || fmt.StartsWith("img:"))
            return true;

        // Heuristic tên cột: main_image, image_url, thumb, avatar...
        if (name.Contains("image") ||
            name.Contains("img") ||
            name.Contains("thumb") ||
            name.Contains("avatar") ||
            name.Contains("photo"))
        {
            return true;
        }

        return false;
    }

    string MaskPhone(string s)
    {
        if (string.IsNullOrWhiteSpace(s)) return string.Empty;

        // bỏ khoảng trắng để mask, nhưng vẫn hiển thị nguyên bản s
        var digits = new string(s.Where(char.IsDigit).ToArray());
        if (digits.Length <= 5) return s; // quá ngắn, khỏi mask

        // Ví dụ: 09*****123
        var first = digits.Substring(0, 2);
        var last = digits.Substring(digits.Length - 3);
        var maskedCore = new string('*', digits.Length - 5);

        // ghép lại theo pattern
        return first + maskedCore + last;
    }

    string MaskEmail(string s)
    {
        if (string.IsNullOrWhiteSpace(s)) return string.Empty;

        var atIndex = s.IndexOf('@');
        if (atIndex <= 0) return s; // không giống email

        var local = s.Substring(0, atIndex);
        var domain = s.Substring(atIndex); // gồm luôn '@'

        if (local.Length <= 1)
        {
            // a@domain -> giữ nguyên
            return s;
        }

        // a***@domain.com
        var firstChar = local[0];
        return firstChar + new string('*', Math.Max(3, local.Length - 1)) + domain;
    }

    string RenderCell(CmsTools.Models.CmsColumnMeta col, object? value)
    {
        if (value == null || value is DBNull) return string.Empty;

        var s = value.ToString() ?? string.Empty;
        var fmt = (col.Format ?? string.Empty).Trim();

        if (string.IsNullOrEmpty(fmt))
            return s;

        var lower = fmt.ToLowerInvariant();

        // ======== MASK PHONE / EMAIL ========
        if (lower.StartsWith("mask:"))
        {
            if (lower == "mask:phone")
                return MaskPhone(s);

            if (lower == "mask:email")
                return MaskEmail(s);

            // format mask khác chưa hỗ trợ -> trả về raw
            return s;
        }

        try
        {
            // ======== ĐẶC BIỆT: DATE/DATETIME/TIME ========
            if (value is DateTime dt)
            {
                if (lower == "datetime")
                    return dt.ToString("dd/MM/yyyy HH:mm", CultureInfo.CurrentCulture);

                if (lower == "date")
                    return dt.ToString("dd/MM/yyyy", CultureInfo.CurrentCulture);

                if (lower == "time")
                    return dt.ToString("HH:mm", CultureInfo.CurrentCulture);
            }

            // ======== CÁC FORMAT .NET BÌNH THƯỜNG (N0, N2, …) ========
            if (value is IFormattable f)
            {
                return f.ToString(fmt, CultureInfo.CurrentCulture) ?? s;
            }

            return s;
        }
        catch
        {
            // Nếu format lỗi thì fallback ra text thường
            return s;
        }
    }

    string BuildThStyle(CmsTools.Models.CmsColumnMeta c)
    {
        if (c.Width.HasValue && c.Width.Value > 0)
        {
            return $"min-width:{c.Width.Value}px;max-width:{c.Width.Value + 60}px;";
        }
        return string.Empty;
    }
}





@{
    var title = Model.Table.DisplayName ?? Model.Table.TableName;
    ViewData["Title"] = title;
}

<h2 class="mt-3 mb-3">@title</h2>

<p class="mb-2">
    Table: <strong>@Model.Table.FullName</strong><br />
    Total rows: <strong>@Model.Total</strong>
</p>

<div class="d-flex flex-wrap align-items-center mb-3">
    @if (Model.Permission?.CanCreate == true)
    {
        <a class="btn btn-success me-2 mb-2"
           href="/Data/Create?tableId=@Model.Table.Id">
            Thêm bản ghi mới
        </a>
    }

    <!-- Nút export CSV: giữ nguyên query string hiện tại -->
    <a class="btn btn-outline-secondary mb-2"
       href="@($"{Url.Action("ExportCsv", "Data")}{Context.Request.QueryString}")">
        Xuất CSV
    </a>
</div>

@if (Model.FilterColumns != null && Model.FilterColumns.Count > 0)
{
    <form method="get" class="row g-2 mb-3">
        <input type="hidden" name="tableId" value="@Model.Table.Id" />
        <input type="hidden" name="page" value="1" />
        <input type="hidden" name="pageSize" value="@Model.PageSize" />

        @foreach (var col in Model.FilterColumns)
        {
            var name = col.ColumnName;
            var label = col.DisplayName ?? col.ColumnName;
            Model.Filters.TryGetValue(name, out var currentValue);

            <div class="col-12 col-md-3">
                <label class="form-label small">@label</label>
                <input name="@name"
                       class="form-control form-control-sm"
                       value="@(currentValue ?? "")" />
            </div>
        }

        <div class="col-12 mt-2">
            <button type="submit" class="btn btn-primary btn-sm me-2">
                Lọc
            </button>
            <a class="btn btn-outline-secondary btn-sm"
               href="/Data/List?tableId=@Model.Table.Id">
                Xoá lọc
            </a>
        </div>
    </form>
}

<table class="table table-striped table-sm table-bordered">
    <thead>
        <tr>
            @foreach (var c in Model.Columns)
            {
                var thStyle = BuildThStyle(c);
                <th style="@thStyle">
                    @(c.DisplayName ?? c.ColumnName)
                </th>
            }
            <th style="width:160px;">Thao tác</th>
        </tr>
    </thead>

    <tbody>
        @foreach (System.Collections.Generic.IDictionary<string, object?> row in Model.Rows)
        {
            <tr>
                @foreach (var c in Model.Columns)
                {
                    object? cell = null;
                    if (row != null && row.ContainsKey(c.ColumnName))
                    {
                        cell = row[c.ColumnName];
                    }

                    // 1) Cột ảnh
                    var isImageCol =
                    (!string.IsNullOrEmpty(c.Format) &&
                    c.Format.Equals("image", System.StringComparison.OrdinalIgnoreCase))
                    || c.ColumnName.IndexOf("image", System.StringComparison.OrdinalIgnoreCase) >= 0
                    || c.ColumnName.IndexOf("img", System.StringComparison.OrdinalIgnoreCase) >= 0
                    || c.ColumnName.IndexOf("photo", System.StringComparison.OrdinalIgnoreCase) >= 0
                    || c.ColumnName.IndexOf("avatar", System.StringComparison.OrdinalIgnoreCase) >= 0;

                    if (isImageCol)
                    {
                        var url = cell?.ToString() ?? string.Empty;
                        if (string.IsNullOrWhiteSpace(url))
                        {
                            <td></td>
                        }
                        else
                        {
                            <td>
                                <a href="@url" target="_blank" rel="noopener noreferrer">
                                    <img src="@url"
                                         alt="img"
                                         style="max-height:40px;max-width:80px;object-fit:contain;" />
                                </a>
                            </td>
                        }
                    }
                    // 2) Cột status -> badge
                    else if (string.Equals(c.ColumnName, "status", System.StringComparison.OrdinalIgnoreCase)
                    && cell is not null)
                    {
                        byte statusByte;
                        if (byte.TryParse(cell.ToString(), out statusByte))
                        {
                            <td>
                                @if (statusByte == 1)
                                {
                                    <span class="badge bg-success">Active</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Inactive</span>
                                }
                            </td>
                        }
                        else
                        {
                            <td>@RenderCell(c, cell)</td>
                        }
                    }
                    // 3) Các cột còn lại
                    else
                    {
                        <td>@RenderCell(c, cell)</td>
                    }
                }

                <td>
                    @{
                        object? idValue = null;
                        if (row != null && row.ContainsKey("id"))
                        {
                            idValue = row["id"];
                        }
                    }

                    @* nút Sửa / Xem tuỳ quyền *@
                    @if (idValue != null)
                    {
                        if (Model.Permission?.CanUpdate == true)
                        {
                            <a class="btn btn-sm btn-primary me-1"
                               href="/Data/Edit?tableId=@Model.Table.Id&id=@idValue">
                                Sửa
                            </a>
                        }
                        else if (Model.Permission?.CanView == true)
                        {
                            <a class="btn btn-sm btn-outline-secondary me-1"
                               href="/Data/Details?tableId=@Model.Table.Id&id=@idValue">
                                Xem
                            </a>
                        }

                        @* 👉 Nút custom detail theo meta, dùng chung cho mọi bảng *@
                        if (!string.IsNullOrWhiteSpace(Model.Table.CustomDetailUrl))
                        {
                            var idStr = idValue.ToString();
                            var url = Model.Table.CustomDetailUrl
                            .Replace("{id}", idStr)   // pattern chính
                            .Replace("{pk}", idStr);  // optional, nếu sau này muốn dùng {pk}

                            <a class="btn btn-sm btn-outline-secondary me-1"
                               href="@url">
                                Chi tiết
                            </a>
                        }
                    }

                    @if (idValue != null
                                    && Model.Permission != null
                                    && (Model.Permission.CanUpdate || Model.Permission.CanDelete)
                                    && Model.Columns.Any(x => x.ColumnName.Equals("status", System.StringComparison.OrdinalIgnoreCase)))
                    {
                        object? statusObj = null;
                        if (row != null && row.ContainsKey("status"))
                        {
                            statusObj = row["status"];
                        }

                        byte statusByte = 0;
                        byte.TryParse(statusObj?.ToString(), out statusByte);

                        <form method="post"
                              asp-controller="Data"
                              asp-action="SetStatus"
                              asp-route-tableId="@Model.Table.Id"
                              asp-route-id="@idValue"
                              class="d-inline">
                            @Html.AntiForgeryToken()

                            @if (statusByte == 1)
                            {
                                <input type="hidden" name="status" value="0" />
                                <button type="submit" class="btn btn-sm btn-warning">
                                    Ẩn
                                </button>
                            }
                            else
                            {
                                <input type="hidden" name="status" value="1" />
                                <button type="submit" class="btn btn-sm btn-success">
                                    Kích hoạt
                                </button>
                            }
                        </form>
                    }
                </td>

            </tr>
        }

    </tbody>
</table>

@if (Model.TotalPages > 1)
{
    <nav class="mt-3">
        <ul class="pagination pagination-sm">
            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                var active = (i == Model.Page);
                <li class="page-item @(active ? "active" : "")">
                    <a class="page-link"
                       href="/Data/List?tableId=@Model.Table.Id&page=@i&pageSize=@Model.PageSize">
                        @i
                    </a>
                </li>
            }
        </ul>
    </nav>
}

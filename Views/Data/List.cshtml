@model CmsTools.Models.DataListViewModel
@using System.Globalization

@section Scripts {
    <script>
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('[data-cms-modal]');
            if (!btn) return;

            e.preventDefault();

            const url = btn.getAttribute('data-url');
            if (!url) return;

            const modalEl = document.getElementById('cmsRowModal');
            const modalBody = document.getElementById('cmsRowModalBody');
            const modalTitleEl = document.getElementById('cmsRowModalTitle');

            if (!modalEl || !modalBody) return;

            const title = btn.getAttribute('data-title');
            if (modalTitleEl && title) {
                modalTitleEl.textContent = title;
            }

            modalBody.innerHTML =
                '<div class="text-center text-muted small p-3">Đang tải...</div>';

            fetch(url, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
                .then(r => r.text())
                .then(html => {
                    modalBody.innerHTML = html;
                })
                .catch(err => {
                    console.error(err);
                    modalBody.innerHTML =
                        '<div class="text-danger p-3">Lỗi tải dữ liệu.</div>';
                });

            const bsModal = new bootstrap.Modal(modalEl);
            bsModal.show();
        });

        // ===== AJAX submit cho form trong modal =====
        document.addEventListener('submit', function (e) {
            const form = e.target;
            if (!form.matches('form[data-cms-ajax="true"], form[data_cms_ajax="true"]')) return;

            // Cho browser chạy HTML5 validation
            if (!form.checkValidity()) {
                // Không preventDefault để browser highlight lỗi
                return;
            }

            e.preventDefault();

            const modalBody = document.getElementById('cmsRowModalBody');
            if (modalBody) {
                modalBody.classList.remove('cmstools-modal-error');
            }

                   const action = form.getAttribute('action') || window.location.href;
        const method = (form.getAttribute('method') || 'post').toUpperCase();

        // Tạo FormData từ form
        const fd = new FormData(form);

        // 👇 THÊM: gắn thêm nút submit đã bấm (newStatus, v.v.)
        const submitter = e.submitter;   // Chrome, Edge, Firefox mới đều hỗ trợ
        if (submitter && submitter.name) {
            fd.append(submitter.name, submitter.value);
        }

        fetch(action, {
            method: method,
            body: fd,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
            .then(async res => {
                const ct = (res.headers.get('content-type') || '').toLowerCase();

                if (ct.includes('application/json')) {
                    const data = await res.json().catch(() => null);

                    if (data && data.ok) {
                        window.location.reload();
                        return;
                    }

                    if (data && data.message) {
                        alert(data.message);
                    } else {
                        alert('Có lỗi khi cập nhật, nhưng server không trả message.');
                    }
                    return;
                }

                const html = await res.text();
                if (modalBody) {
                    modalBody.innerHTML = html;
                    modalBody.classList.add('cmstools-modal-error');
                }
            })
            .catch(err => {
                console.error(err);
                if (modalBody) {
                    modalBody.innerHTML =
                        '<div class="text-danger p-3">Lỗi gửi dữ liệu.</div>';
                    modalBody.classList.add('cmstools-modal-error');
                }
            });


        });


                
    </script>
}




@functions {
    bool IsImageColumn(CmsTools.Models.CmsColumnMeta col)
    {
        var name = (col.ColumnName ?? string.Empty).ToLowerInvariant();
        var fmt = (col.Format ?? string.Empty).ToLowerInvariant();

        // Ưu tiên format
        if (fmt == "img" || fmt == "image" || fmt.StartsWith("img:"))
            return true;

        if (name.Contains("image") ||
            name.Contains("img") ||
            name.Contains("thumb") ||
            name.Contains("avatar") ||
            name.Contains("photo"))
        {
            return true;
        }

        return false;
    }

    string MaskPhone(string s)
    {
        if (string.IsNullOrWhiteSpace(s)) return string.Empty;

        var digits = new string(s.Where(char.IsDigit).ToArray());
        if (digits.Length <= 5) return s;

        var first = digits.Substring(0, 2);
        var last = digits.Substring(digits.Length - 3);
        var maskedCore = new string('*', digits.Length - 5);
        return first + maskedCore + last;
    }

    string MaskEmail(string s)
    {
        if (string.IsNullOrWhiteSpace(s)) return string.Empty;

        var atIndex = s.IndexOf('@');
        if (atIndex <= 0) return s;

        var local = s.Substring(0, atIndex);
        var domain = s.Substring(atIndex);

        if (local.Length <= 1)
            return s;

        var firstChar = local[0];
        return firstChar + new string('*', Math.Max(3, local.Length - 1)) + domain;
    }

    string RenderCell(CmsTools.Models.CmsColumnMeta col, object? value)
    {
        if (value == null || value is DBNull) return string.Empty;

        var s = value.ToString() ?? string.Empty;
        var fmt = (col.Format ?? string.Empty).Trim();

        if (string.IsNullOrEmpty(fmt))
            return s;

        var lower = fmt.ToLowerInvariant();

        // ===== MASK PHONE / EMAIL =====
        if (lower.StartsWith("mask:"))
        {
            if (lower == "mask:phone")
                return MaskPhone(s);

            if (lower == "mask:email")
                return MaskEmail(s);

            return s;
        }

        // 🔹 Format riêng cho status của review
        if (lower == "reviewstatus")
        {
            if (byte.TryParse(s, out var b))
            {
                return b switch
                {
                    0 => "Chờ duyệt",
                    1 => "Đã duyệt",
                    2 => "Đã từ chối",
                    _ => b.ToString()
                };
            }
            return s;
        }


        try
        {
            if (value is DateTime dt)
            {
                if (lower == "datetime")
                    return dt.ToString("dd/MM/yyyy HH:mm", CultureInfo.CurrentCulture);

                if (lower == "date")
                    return dt.ToString("dd/MM/yyyy", CultureInfo.CurrentCulture);

                if (lower == "time")
                    return dt.ToString("HH:mm", CultureInfo.CurrentCulture);
            }

            if (value is IFormattable f)
            {
                return f.ToString(fmt, CultureInfo.CurrentCulture) ?? s;
            }

            return s;
        }
        catch
        {
            return s;
        }
    }

    string BuildThStyle(CmsTools.Models.CmsColumnMeta c)
    {
        if (c.Width.HasValue && c.Width.Value > 0)
        {
            return $"min-width:{c.Width.Value}px;max-width:{c.Width.Value + 60}px;";
        }
        return string.Empty;
    }
}

@{
    var title = Model.Table.DisplayName ?? Model.Table.TableName;
    ViewData["Title"] = title;
}
@{
    var idCol = Model.Columns
        .FirstOrDefault(c => c.ColumnName.Equals("id", StringComparison.OrdinalIgnoreCase));
    var otherCols = Model.Columns
        .Where(c => !c.ColumnName.Equals("id", StringComparison.OrdinalIgnoreCase))
        .ToList();
}

<div class="cmstools-page-header">
    <div>
        <h2 class="cmstools-page-title">@title</h2>
        <div class="cmstools-page-subtitle">
            <span>Table: <strong>@Model.Table.FullName</strong></span>
            <span class="ms-3">Total rows: <strong>@Model.Total</strong></span>
        </div>
    </div>

    <div class="cmstools-page-actions">
        @if (Model.Permission?.CanCreate == true)
        {
            <button type="button"
                    class="btn btn-success btn-sm me-2"
                    data-cms-modal="form"
                    data-title="Thêm bản ghi - @(Model.Table.DisplayName ?? Model.Table.TableName)"
                    data-url="@Url.Action("CreateForm", "Data", new { tableId = Model.Table.Id })">
                Thêm bản ghi mới
            </button>
        }

        <a class="btn btn-outline-secondary btn-sm"
           href="@($"{Url.Action("ExportCsv", "Data")}{Context.Request.QueryString}")">
            Xuất CSV
        </a>
    </div>


</div>

@if (Model.FilterColumns != null && Model.FilterColumns.Count > 0)
{
    <div class="card mb-3">
        <div class="card-body py-2">
            <form method="get" class="row g-2 cmstools-filter-row">
                <input type="hidden" name="tableId" value="@Model.Table.Id" />
                <input type="hidden" name="page" value="1" />
                <input type="hidden" name="pageSize" value="@Model.PageSize" />

                @foreach (var col in Model.FilterColumns)
                {
                    var name = col.ColumnName;
                    var label = col.DisplayName ?? col.ColumnName;
                    Model.Filters.TryGetValue(name, out var currentValue);

                    <div class="col-12 col-md-3">
                        <label class="form-label small mb-1">@label</label>
                        <input name="@name"
                               class="form-control form-control-sm"
                               value="@(currentValue ?? "")" />
                    </div>
                }

                <div class="col-12 mt-1">
                    <button type="submit" class="btn btn-primary btn-sm me-2">
                        Lọc
                    </button>
                    <a class="btn btn-outline-secondary btn-sm"
                       href="/Data/List?tableId=@Model.Table.Id">
                        Xoá lọc
                    </a>
                </div>
            </form>
        </div>
    </div>
}

@if (Model.Rows == null || !Model.Rows.Any())
{
    <p class="text-muted">Không có dữ liệu.</p>
}
else
{
    <div class="cmstools-table-container">
        <div class="cmstools-table-scroll">
            <table class="table table-striped table-sm table-bordered cmstools-table mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="cmstools-th cmstools-th-actions text-nowrap" style="min-width:180px;">
                            Thao tác
                        </th>

                        @* Cột ID nếu có *@
                        @if (idCol != null)
                        {
                            <th class="cmstools-th text-nowrap" style="width:80px;">
                                @(idCol.DisplayName ?? idCol.ColumnName)
                            </th>
                        }

                        @* Các cột còn lại *@
                        @foreach (var c in otherCols)
                        {
                            var thStyle = BuildThStyle(c);
                            <th class="cmstools-th text-nowrap" style="@thStyle">
                                @(c.DisplayName ?? c.ColumnName)
                            </th>
                        }
                    </tr>
                </thead>



                <tbody>
                    @foreach (System.Collections.Generic.IDictionary<string, object?> row in Model.Rows)
                    {
                        // Lấy idValue một lần để dùng cho cả action + cột ID
                        object? idValue = null;
                        if (row != null && row.ContainsKey("id"))
                        {
                            idValue = row["id"];
                        }

                        <tr>
                            @* ==== CỘT THAO TÁC (ĐẦU TIÊN) ==== *@
                            <td class="cmstools-td cmstools-td-actions text-nowrap">
                                @if (idValue != null)
                                {
                                    @if (Model.Permission?.CanUpdate == true)
                                    {
                                        <button type="button"
                                                class="btn btn-sm btn-primary me-1"
                                                data-cms-modal="form"
                                                data-title="Sửa - @(Model.Table.DisplayName ?? Model.Table.TableName) (#@idValue)"
                                                data-url="@Url.Action("EditForm", "Data",
                                                                                          new { tableId = Model.Table.Id, id = idValue })">
                            Sửa
                        </button>
                                                }
                                    else if (Model.Permission?.CanView == true)
                                    {
                                        <a class="btn btn-sm btn-outline-secondary me-1"
                                           href="/Data/Details?tableId=@Model.Table.Id&id=@idValue">
                                            Xem
                                        </a>
                                    }

                                    @* Link chi tiết custom (nếu có) *@
                                    if (!string.IsNullOrWhiteSpace(Model.Table.CustomDetailUrl))
                                    {
                                        var idStr = idValue.ToString();
                                        var url = Model.Table.CustomDetailUrl
                                        .Replace("{id}", idStr)
                                        .Replace("{pk}", idStr);

                                        <a class="btn btn-sm btn-outline-secondary me-1"
                                           href="@url">
                                            Chi tiết
                                        </a>
                                    }

                                    <button type="button"
                                            class="btn btn-sm btn-outline-secondary me-1"
                                            data-cms-modal="row"
                                            data-title="Xem nhanh - @(Model.Table.DisplayName ?? Model.Table.TableName) (#@idValue)"
                                            data-url="@Url.Action("DetailsModal", "Data",
                                                                                  new { tableId = Model.Table.Id, id = idValue })">
                            Xem nhanh
                        </button>

                                    @* 👉 NÚT DUYỆT REVIEW – chỉ hiện cho bảng tbl_product_review *@
                        @if (string.Equals(Model.Table.TableName, "tbl_product_review", StringComparison.OrdinalIgnoreCase)
                                                && Model.Permission?.CanUpdate == true)
                                    {
                                        <button type="button"
                                                class="btn btn-sm btn-outline-primary me-1"
                                                data-cms-modal="row"
                                                data-title="Duyệt đánh giá #@idValue"
                                                data-url="@Url.Action("Modal", "AdminReviews", new { id = idValue })">
                                            Duyệt
                                        </button>
                                    }
                                                }


                               
                                

                                @* Nút Ẩn / Kích hoạt nếu có status *@

                                @if (idValue != null
                                                        && Model.Permission != null
                                                        && (Model.Permission.CanUpdate || Model.Permission.CanDelete)
                                                        && Model.Columns.Any(x => x.ColumnName.Equals("status", System.StringComparison.OrdinalIgnoreCase))
                                                        && !Model.Table.TableName.Equals("tbl_product_review", StringComparison.OrdinalIgnoreCase))   @* 🔹 thêm điều kiện này *@
                                {
                                    object? statusObj = null;
                                    if (row != null && row.ContainsKey("status"))
                                    {
                                        statusObj = row["status"];
                                    }

                                    byte statusByte = 0;
                                    byte.TryParse(statusObj?.ToString(), out statusByte);

                                    <form method="post"
                                          asp-controller="Data"
                                          asp-action="SetStatus"
                                          asp-route-tableId="@Model.Table.Id"
                                          asp-route-id="@idValue"
                                          class="d-inline">
                                        @Html.AntiForgeryToken()

                                        @if (statusByte == 1)
                                        {
                                            <input type="hidden" name="status" value="0" />
                                            <button type="submit" class="btn btn-sm btn-warning">
                                                Ẩn
                                            </button>
                                        }
                                        else
                                        {
                                            <input type="hidden" name="status" value="1" />
                                            <button type="submit" class="btn btn-sm btn-success">
                                                Kích hoạt
                                            </button>
                                        }
                                    </form>
                                }


                                
                            </td>

                            @* ==== CỘT ID (THỨ HAI) NẾU CÓ ==== *@
                            @if (idCol != null)
                            {
                                object? cellId = null;
                                if (row != null && row.ContainsKey(idCol.ColumnName))
                                {
                                    cellId = row[idCol.ColumnName];
                                }

                                <td class="cmstools-td text-nowrap">
                                    @RenderCell(idCol, cellId)
                                </td>
                            }

                            @* ==== CÁC CỘT DỮ LIỆU CÒN LẠI ==== *@
                            @foreach (var c in otherCols)
                            {
                                object? cell = null;
                                if (row != null && row.ContainsKey(c.ColumnName))
                                {
                                    cell = row[c.ColumnName];
                                }

                                var isImageCol = IsImageColumn(c);

                                if (isImageCol)
                                {
                                    var url = cell?.ToString() ?? string.Empty;
                                    if (string.IsNullOrWhiteSpace(url))
                                    {
                                        <td class="cmstools-td"></td>
                                    }
                                    else
                                    {
                                        <td class="cmstools-td">
                                            <a href="@url" target="_blank" rel="noopener noreferrer">
                                                <img src="@url"
                                                     alt="img"
                                                     class="cmstools-img-thumb" />
                                            </a>
                                        </td>
                                    }
                                }
                                else if (string.Equals(c.ColumnName, "status", System.StringComparison.OrdinalIgnoreCase)
                                && cell is not null)
                                {
                                    byte statusByte;
                                    if (byte.TryParse(cell.ToString(), out statusByte))
                                    {
                                        <td class="cmstools-td">
                                            @* 🔹 Nếu là bảng review hoặc format = reviewStatus thì dùng 3 trạng thái *@
                                            @if (Model.Table.TableName.Equals("tbl_product_review", StringComparison.OrdinalIgnoreCase)
                                                                    || string.Equals(c.Format, "reviewStatus", StringComparison.OrdinalIgnoreCase))
                                            {
                                                if (statusByte == 0)
                                                {
                                                    <span class="badge bg-warning text-dark">Chờ duyệt</span>
                                                }
                                                else if (statusByte == 1)
                                                {
                                                    <span class="badge bg-success">Đã duyệt</span>
                                                }
                                                else if (statusByte == 2)
                                                {
                                                    <span class="badge bg-danger">Đã từ chối</span>
                                                }
                                                else
                                                {
                                                    @statusByte.ToString()
                                                }
                                            }
                                            else
                                            {
                                                @* Mặc định cho bảng khác: Active / Inactive *@
                                                if (statusByte == 1)
                                                {
                                                    <span class="badge bg-success">Active</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">Inactive</span>
                                                }
                                            }
                                        </td>
                                    }
                                    else
                                    {
                                        <td class="cmstools-td">@RenderCell(c, cell)</td>
                                    }
                                }

                                else
                                {
                                    <td class="cmstools-td">@RenderCell(c, cell)</td>
                                }
                            }
                        </tr>
                    }
                </tbody>


            </table>
        </div>
    </div>
}

@if (Model.TotalPages > 1)
{
    <nav class="mt-3">
        <ul class="pagination pagination-sm flex-wrap">
            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                var active = (i == Model.Page);
                <li class="page-item @(active ? "active" : "")">
                    <a class="page-link"
                       asp-controller="Data"
                       asp-action="List"
                       asp-route-tableId="@Model.Table.Id"
                       asp-route-page="@i"
                       asp-route-pageSize="@Model.PageSize"
                       asp-all-route-data="Model.Filters">
                        @i
                    </a>
                </li>
            }
        </ul>
    </nav>
}

<!-- Modal xem nhanh 1 bản ghi (luôn luôn render) -->
<div class="modal fade" id="cmsRowModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h5 class="modal-title" id="cmsRowModalTitle">
                    Xem nhanh - @(Model.Table.DisplayName ?? Model.Table.TableName)
                </h5>
                <button type="button" class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body" id="cmsRowModalBody">
                <div class="text-center text-muted small p-3">
                    Đang tải...
                </div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        data-bs-dismiss="modal">
                    Đóng
                </button>
            </div>
        </div>
    </div>
</div>


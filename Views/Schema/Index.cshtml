@model CmsTools.Models.SchemaIndexViewModel

@{
    ViewData["Title"] = "Schema";

    // lấy connectionId từ query string để highlight/mở đúng card
    int? selectedConnId = null;
    var qConn = Context.Request.Query["connectionId"].ToString();
    if (int.TryParse(qConn, out var tmp)) selectedConnId = tmp;
}

<h2 class="mt-3 mb-3">Schema</h2>

@if (TempData["SchemaMessage"] is string msg && !string.IsNullOrWhiteSpace(msg))
{
    <div class="alert alert-info">@msg</div>
}

@if (Model?.Items != null && Model.Items.Count > 0)
{
    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
        <div class="input-group" style="max-width:520px;">
            <span class="input-group-text">DB</span>
            <select id="connSelect" class="form-select">
                <option value="">-- Tất cả connections --</option>
                @foreach (var it in Model.Items.OrderBy(x => x.Connection.Name))
                {
                    var c = it.Connection;
                    var sel = (selectedConnId.HasValue && selectedConnId.Value == c.Id) ? "selected" : null;
                    <option value="@c.Id" selected="@sel">
                        @c.Name (Id=@c.Id)
                    </option>
                }
            </select>
            <button id="btnGoConn" class="btn btn-outline-primary" type="button">Xem</button>
            <a class="btn btn-outline-secondary" href="@Url.Action("Index", "Schema")">Tất cả</a>
        </div>

        <div class="ms-auto text-muted small">
            Tổng connections: <strong>@Model.Items.Count</strong>
        </div>
    </div>
}

<div class="mb-3">
    <div class="input-group" style="max-width:760px;">
        <span class="input-group-text">Tìm bảng</span>
        <input id="schemaSearch" class="form-control"
               placeholder="Nhập tên bảng... (vd: orders, review, article, tbl_)" />
        <button id="schemaClear" class="btn btn-outline-secondary" type="button">X</button>
    </div>
    <small class="text-muted">Lọc theo: schema / table_name / display_name (trong DB đang mở)</small>
</div>

@if (Model?.Items == null || Model.Items.Count == 0)
{
    <p class="text-muted">
        Chưa có connection nào trong <code>tbl_cms_connection</code>.
        Hãy vào menu <strong>Connections</strong> để thêm connection.
    </p>
}
else
{
    foreach (var grp in Model.Items.OrderBy(x => x.Connection.Name))
    {
        var c = grp.Connection;
        var tables = grp.Tables ?? new List<CmsTools.Models.CmsTableMeta>();

        var isOpen = !selectedConnId.HasValue || selectedConnId.Value == c.Id; // nếu chưa chọn DB -> mở hết, còn chọn -> chỉ mở DB đó
        var collapseId = $"connCollapse_{c.Id}";

        <div class="card mb-3 schema-conn-card" data-conn-id="@c.Id">
            <div class="card-header d-flex justify-content-between align-items-center">
                <button class="btn btn-link text-decoration-none p-0"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#@collapseId"
                        aria-expanded="@(isOpen ? "true" : "false")"
                        aria-controls="@collapseId">
                    <strong>@c.Name</strong>
                    <small class="text-muted ms-2">(ConnectionId = @c.Id)</small>

                    @if (!c.IsActive)
                    {
                        <span class="badge bg-secondary ms-2">Inactive</span>
                    }

                    <span class="badge bg-light text-dark ms-2">Tables: @tables.Count</span>
                </button>

                <div class="d-flex gap-2">
                    <a class="btn btn-sm btn-outline-secondary"
                       href="@Url.Action("Index", "Schema", new { connectionId = c.Id })">
                        Chỉ DB này
                    </a>

                    <form asp-controller="Schema"
                          asp-action="Scan"
                          method="post"
                          class="mb-0">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="connectionId" value="@c.Id" />
                        <button type="submit" class="btn btn-sm btn-outline-primary" @(c.IsActive ? null : "disabled")>
                            Scan schema
                        </button>
                    </form>
                </div>
            </div>

            <div id="@collapseId" class="collapse @(isOpen ? "show" : "")">
                <div class="card-body p-2">
                    @if (tables.Count == 0)
                    {
                        <div class="text-muted p-2">
                            Connection này chưa có bảng trong <code>tbl_cms_table</code>.
                            Bấm <strong>Scan schema</strong> để nạp bảng/cột.
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width:60px;">ID</th>
                                        <th>Schema</th>
                                        <th>Tên bảng</th>
                                        <th>Tên hiển thị</th>
                                        <th>Primary key</th>
                                        <th>Custom detail URL</th>
                                        <th style="width:260px;">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var t in tables.OrderBy(x => x.SchemaName).ThenBy(x => x.TableName))
                                    {
                                        var display = string.IsNullOrWhiteSpace(t.DisplayName) ? "(chưa đặt)" : t.DisplayName;

                                        <tr class="schema-row"
                                            data-conn="@c.Id"
                                            data-search="@($"{t.SchemaName} {t.TableName} {t.DisplayName}".ToLowerInvariant())">
                                            <td>@t.Id</td>
                                            <td>@t.SchemaName</td>
                                            <td>@t.TableName</td>
                                            <td>@display</td>
                                            <td>@(t.PrimaryKey ?? "")</td>

                                            <td>
                                                @if (!string.IsNullOrWhiteSpace(t.CustomDetailUrl))
                                                {
                                                    <code>@t.CustomDetailUrl</code>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>

                                            <td>
                                                <a class="btn btn-sm btn-outline-secondary me-2"
                                                   href="@Url.Action("Columns", "Schema", new { tableId = t.Id })">
                                                    Cấu hình cột
                                                </a>

                                                <a class="btn btn-sm btn-outline-primary me-2"
                                                   href="@Url.Action("List", "Data", new { tableId = t.Id })"
                                                   target="_blank" rel="noopener">
                                                    Xem dữ liệu
                                                </a>

                                                @if (!string.IsNullOrWhiteSpace(t.CustomDetailUrl))
                                                {
                                                    var sampleUrl = t.CustomDetailUrl.Replace("{id}", "0").Replace("{pk}", "0");
                                                    <a class="btn btn-sm btn-outline-secondary"
                                                       href="@sampleUrl"
                                                       target="_blank" rel="noopener">
                                                        Thử URL
                                                    </a>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
}

@section Scripts {
    <script>
        (function () {
            const input = document.getElementById('schemaSearch');
            const clear = document.getElementById('schemaClear');

            const sel = document.getElementById('connSelect');
            const btnGo = document.getElementById('btnGoConn');

            function goConn() {
                const v = (sel && sel.value) ? sel.value : '';
                if (!v) window.location.href = '@Url.Action("Index", "Schema")';
                else window.location.href = '@Url.Action("Index", "Schema")' + '?connectionId=' + encodeURIComponent(v);
            }

            btnGo?.addEventListener('click', goConn);
            sel?.addEventListener('change', function () {
                // đổi DB là chuyển trang luôn cho nhanh
                goConn();
            });

            function applySearch() {
                const q = (input?.value || '').trim().toLowerCase();

                // chỉ filter trong các DB đang "show" (collapse mở)
                document.querySelectorAll('.schema-conn-card').forEach(card => {
                    const body = card.querySelector('.collapse');
                    const isShown = body && body.classList.contains('show');
                    if (!isShown) return;
                    card.querySelectorAll('.schema-row').forEach(tr => {
                        const hay = tr.getAttribute('data-search') || '';
                        tr.style.display = (!q || hay.includes(q)) ? '' : 'none';
                    });
                });
            }

            input?.addEventListener('input', applySearch);
            clear?.addEventListener('click', () => { if (input) { input.value = ''; applySearch(); input.focus(); } });

            // nếu đang mở 1 DB cụ thể -> auto focus search
            if (@(selectedConnId.HasValue ? "true" : "false")) {
                setTimeout(() => input?.focus(), 50);
            }
        })();
    </script>
}
